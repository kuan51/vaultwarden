version: "3"

services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    env_file:
      - vaultwarden.env
    environment:
      - USE_SYSLOG=true
      - LOG_LEVEL=warn
      - EXTENDED_LOGGING=true
    volumes:
      - ./vw-data/:/data/
    ports:
      - "80:80"
    restart: unless-stopped
    networks:
      - vaultwarden
    user: 1000:1000

  vaultwarden-db:
    image: "mariadb"
    container_name: "vaultwarden-db"
    restart: always
    env_file:
    - vaultwarden.env
    networks:
      - vaultwarden
    volumes:
    - "vw-db:/var/lib/mysql"
    healthcheck:
      test: mariadb-admin ping -h 127.0.0.1 -u $$MYSQL_USER --password=$$MYSQL_PASSWORD
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 55

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    env_file:
      - vaultwarden.env
    command: tunnel run $CF_TUN_ID
    environment:
      - TUNNEL_TOKEN=$CF_TUN_TOKEN
    restart: unless-stopped
    networks:
      - vaultwarden
    user: 1000:1000

  fail2ban:
    container_name: fail2ban
    restart: always
    image: crazymax/fail2ban:latest
    environment:
      - TZ=America/Denver
      - F2B_DB_PURGE_AGE=30d
      - F2B_LOG_TARGET=/data/fail2ban.log
      - F2B_LOG_LEVEL=INFO
      - F2B_IPTABLES_CHAIN=INPUT
    volumes:
      - ./fail2ban-data:/data
      - ./vw-data:/vaultwarden:ro
    networks:
      - vaultwarden
    network_mode: "host"
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    user: 1000:1000

networks:
  vaultwarden:
    name: vaultwarden
    external: true

volumes:
 vw-data:
 vw-db: